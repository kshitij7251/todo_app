<!-- Page Header -->
<div class="sm:flex sm:items-center sm:justify-between mb-6">
  <div>
    <h1 class="text-3xl font-bold text-gray-900">Tasks</h1>
    <p class="mt-2 text-sm text-gray-700">Manage your personal todo list</p>
  </div>
  <div class="mt-4 sm:mt-0">
    <%= link_to "New task", new_task_path, 
        class: "inline-flex items-center justify-center rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" %>
  </div>
</div>

<!-- Main Layout with Sidebar -->
<div class="flex gap-6">
  <!-- Left Sidebar with Filters -->
  <div class="w-80 flex-shrink-0">
    <div class="bg-white shadow rounded-lg p-6 sticky top-6">
      <h2 class="text-lg font-medium text-gray-900 mb-4">Filters & Search</h2>
      
      <!-- Search Bar -->
      <div class="mb-6">
        <%= form_with url: tasks_path, method: :get, local: true, class: "space-y-4" do |form| %>
          <div class="relative">
            <%= form.text_field :search, 
                value: params[:search],
                placeholder: "Search tasks and subtasks...", 
                class: "block w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 text-sm" %>
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <span class="text-gray-400 text-lg">üîç</span>
            </div>
          </div>
          
          <!-- Preserve other filters in search -->
          <%= form.hidden_field :completed, value: params[:completed] if params[:completed].present? %>
          <%= form.hidden_field :priority, value: params[:priority] if params[:priority].present? %>
          <%= form.hidden_field :category_id, value: params[:category_id] if params[:category_id].present? %>
          <%= form.hidden_field :filter, value: params[:filter] if params[:filter].present? %>
          <%= form.hidden_field :quick_filter, value: params[:quick_filter] if params[:quick_filter].present? %>
          
          <div class="flex space-x-2">
            <%= form.submit "Search", class: "flex-1 inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" %>
            
            <% if params[:search].present? || params[:completed].present? || params[:priority].present? || params[:category_id].present? || params[:filter].present? || params[:quick_filter].present? %>
              <%= link_to "Clear", tasks_path, class: "inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" %>
            <% end %>
          </div>
        <% end %>
      </div>

      <!-- Quick Filters -->
      <div class="mb-6">
        <h3 class="text-sm font-semibold text-gray-900 mb-3">Quick Filters</h3>
        <div class="space-y-2">
          <%= link_to "üéØ My Focus", tasks_path(quick_filter: 'my_focus'), 
              class: "block w-full text-left px-3 py-2 text-sm font-medium rounded-md transition-colors #{params[:quick_filter] == 'my_focus' ? 'bg-blue-50 border-blue-300 text-blue-700 border' : 'text-gray-700 hover:bg-gray-50 border border-transparent'}" %>
          <%= link_to "üìÖ This Week", tasks_path(quick_filter: 'this_week'), 
              class: "block w-full text-left px-3 py-2 text-sm font-medium rounded-md transition-colors #{params[:quick_filter] == 'this_week' ? 'bg-blue-50 border-blue-300 text-blue-700 border' : 'text-gray-700 hover:bg-gray-50 border border-transparent'}" %>
          <%= link_to "üìù With Subtasks", tasks_path(quick_filter: 'with_subtasks'), 
              class: "block w-full text-left px-3 py-2 text-sm font-medium rounded-md transition-colors #{params[:quick_filter] == 'with_subtasks' ? 'bg-blue-50 border-blue-300 text-blue-700 border' : 'text-gray-700 hover:bg-gray-50 border border-transparent'}" %>
          <%= link_to "üè∑Ô∏è No Category", tasks_path(quick_filter: 'no_category'), 
              class: "block w-full text-left px-3 py-2 text-sm font-medium rounded-md transition-colors #{params[:quick_filter] == 'no_category' ? 'bg-blue-50 border-blue-300 text-blue-700 border' : 'text-gray-700 hover:bg-gray-50 border border-transparent'}" %>
        </div>
      </div>

      <!-- Status Filters -->
      <div class="mb-6">
        <h3 class="text-sm font-semibold text-gray-900 mb-3">Status</h3>
        <div class="space-y-2">
          <%= link_to "All Tasks", tasks_path, 
              class: "block w-full text-left px-3 py-2 text-sm font-medium rounded-md transition-colors #{params[:completed].blank? && params[:filter].blank? ? 'bg-blue-50 border-blue-300 text-blue-700 border' : 'text-gray-700 hover:bg-gray-50 border border-transparent'}" %>
          <%= link_to "‚è≥ Pending", tasks_path(completed: false), 
              class: "block w-full text-left px-3 py-2 text-sm font-medium rounded-md transition-colors #{params[:completed] == 'false' ? 'bg-blue-50 border-blue-300 text-blue-700 border' : 'text-gray-700 hover:bg-gray-50 border border-transparent'}" %>
          <%= link_to "‚úÖ Completed", tasks_path(completed: true), 
              class: "block w-full text-left px-3 py-2 text-sm font-medium rounded-md transition-colors #{params[:completed] == 'true' ? 'bg-blue-50 border-blue-300 text-blue-700 border' : 'text-gray-700 hover:bg-gray-50 border border-transparent'}" %>
          <%= link_to "‚ö†Ô∏è Overdue", tasks_path(filter: 'overdue'), 
              class: "block w-full text-left px-3 py-2 text-sm font-medium rounded-md transition-colors #{params[:filter] == 'overdue' ? 'bg-red-50 border-red-300 text-red-700 border' : 'text-gray-700 hover:bg-gray-50 border border-transparent'}" %>
          <%= link_to "üìÖ Due Today", tasks_path(filter: 'due_today'), 
              class: "block w-full text-left px-3 py-2 text-sm font-medium rounded-md transition-colors #{params[:filter] == 'due_today' ? 'bg-orange-50 border-orange-300 text-orange-700 border' : 'text-gray-700 hover:bg-gray-50 border border-transparent'}" %>
        </div>
      </div>

      <!-- Priority Filters -->
      <div class="mb-6">
        <h3 class="text-sm font-semibold text-gray-900 mb-3">Priority</h3>
        <div class="space-y-2">
          <%= link_to "üî¥ High", tasks_path(priority: 'high'), 
              class: "block w-full text-left px-3 py-2 text-sm font-medium rounded-md transition-colors #{params[:priority] == 'high' ? 'bg-red-50 border-red-300 text-red-700 border' : 'text-gray-700 hover:bg-gray-50 border border-transparent'}" %>
          <%= link_to "üü° Medium", tasks_path(priority: 'medium'), 
              class: "block w-full text-left px-3 py-2 text-sm font-medium rounded-md transition-colors #{params[:priority] == 'medium' ? 'bg-yellow-50 border-yellow-300 text-yellow-700 border' : 'text-gray-700 hover:bg-gray-50 border border-transparent'}" %>
          <%= link_to "üü¢ Low", tasks_path(priority: 'low'), 
              class: "block w-full text-left px-3 py-2 text-sm font-medium rounded-md transition-colors #{params[:priority] == 'low' ? 'bg-green-50 border-green-300 text-green-700 border' : 'text-gray-700 hover:bg-gray-50 border border-transparent'}" %>
        </div>
      </div>

      <!-- Category Filters -->
      <% if current_user.categories.any? %>
        <div class="mb-6">
          <h3 class="text-sm font-semibold text-gray-900 mb-3">Categories</h3>
          <div class="space-y-2">
            <% current_user.categories.order(:name).each do |category| %>
              <%= link_to tasks_path(category_id: category.id), 
                  class: "block w-full text-left px-3 py-2 text-sm font-medium rounded-md transition-colors #{params[:category_id] == category.id.to_s ? 'ring-2 ring-blue-500' : 'hover:opacity-80'} #{category.color_classes}" do %>
                üìÅ <%= category.name %> (<%= category.tasks.count %>)
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>
      
      <!-- Active Filters Display -->
      <% active_filters = [] %>
      <% active_filters << "Search: '#{params[:search]}'" if params[:search].present? %>
      <% active_filters << "Status: #{params[:completed] == 'true' ? 'Completed' : 'Pending'}" if params[:completed].present? %>
      <% active_filters << "Priority: #{params[:priority]&.capitalize}" if params[:priority].present? %>
      <% active_filters << "Filter: #{params[:filter]&.humanize}" if params[:filter].present? %>
      <% active_filters << "Quick Filter: #{params[:quick_filter]&.humanize}" if params[:quick_filter].present? %>
      <% if category = current_user.categories.find_by(id: params[:category_id]) %>
        <% active_filters << "Category: #{category.name}" %>
      <% end %>
      
      <% if active_filters.any? %>
        <div class="p-3 bg-blue-50 border border-blue-200 rounded-md">
          <h4 class="text-xs font-semibold text-blue-800 mb-2">ACTIVE FILTERS</h4>
          <div class="space-y-1">
            <% active_filters.each do |filter| %>
              <p class="text-xs text-blue-700"><%= filter %></p>
            <% end %>
          </div>
          <div class="mt-2">
            <%= link_to "Clear All", tasks_path, class: "text-xs text-blue-600 hover:text-blue-800 font-medium" %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="flex-1 min-w-0">
    <!-- Dashboard Stats -->
    <div class="grid grid-cols-2 gap-4 sm:grid-cols-5 mb-6">
      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <span class="text-2xl">üìä</span>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">Total</dt>
                <dd class="text-lg font-medium text-gray-900"><%= @stats[:total] %></dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <span class="text-2xl">‚úÖ</span>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">Completed</dt>
                <dd class="text-lg font-medium text-green-600"><%= @stats[:completed] %></dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <span class="text-2xl">‚è≥</span>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">Pending</dt>
                <dd class="text-lg font-medium text-yellow-600"><%= @stats[:pending] %></dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <span class="text-2xl">‚ö†Ô∏è</span>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">Overdue</dt>
                <dd class="text-lg font-medium text-red-600"><%= @stats[:overdue] %></dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <span class="text-2xl">üìÖ</span>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">Due Today</dt>
                <dd class="text-lg font-medium text-orange-600"><%= @stats[:due_today] %></dd>
              </dl>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Results Summary -->
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center space-x-4">
        <h2 class="text-lg font-medium text-gray-900">
          <% if params[:search].present? || params[:completed].present? || params[:priority].present? || params[:category_id].present? || params[:filter].present? || params[:quick_filter].present? %>
            Filtered Results: 
          <% end %>
          <%= pluralize(@tasks.count, 'task') %>
        </h2>
        <% if @tasks.count != @stats[:total] %>
          <span class="text-sm text-gray-500">
            (of <%= pluralize(@stats[:total], 'total task') %>)
          </span>
        <% end %>
      </div>
      
      <% if @tasks.any? %>
        <div class="text-sm text-gray-500">
          <%= @tasks.completed.count %> completed ‚Ä¢ <%= @tasks.pending.count %> pending
        </div>
      <% end %>
    </div>

    <!-- Tasks Table -->
    <div class="bg-white shadow overflow-hidden sm:rounded-md">
  <% if @tasks.any? %>
    <ul class="divide-y divide-gray-200">
      <% @tasks.each do |task| %>
        <li class="relative group <%= 'bg-red-50' if task.overdue? %>">
          <%= link_to task, class: "block hover:bg-gray-50 transition-colors" do %>
            <div class="px-4 py-4 sm:px-6">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4 flex-1">
                <!-- Task Status Checkbox -->
                <div class="flex-shrink-0">
                  <% if task.completed? %>
                    <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-green-100">
                      <span class="text-lg">‚úÖ</span>
                    </span>
                  <% else %>
                    <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-yellow-100">
                      <span class="text-lg">‚è≥</span>
                    </span>
                  <% end %>
                </div>
                
                <!-- Task Details -->
                <div class="flex-1 min-w-0">
                  <div class="flex items-center space-x-3">
                    <p class="text-lg font-medium text-gray-900 truncate <%= 'line-through text-gray-500' if task.completed? %> group-hover:text-blue-700 transition-colors">
                      <%= highlight_search_term(task.title, params[:search]) %> 
                      <span class="text-xs text-gray-400 group-hover:text-blue-500">‚Üí Click to view details</span>
                    </p>
                    
                    <!-- Category Badge -->
                    <% if task.category.present? %>
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <%= task.category.color_classes %>">
                        üìÅ <%= task.category.name %>
                      </span>
                    <% end %>
                    
                    <!-- Priority Badge -->
                    <% if task.priority.present? %>
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                        <%= case task.priority
                            when 'high' then 'bg-red-100 text-red-800'
                            when 'medium' then 'bg-yellow-100 text-yellow-800'  
                            when 'low' then 'bg-green-100 text-green-800'
                            else 'bg-gray-100 text-gray-800'
                            end %>">
                        <%= task.priority.capitalize %>
                      </span>
                    <% end %>
                  </div>
                  
                  <% if task.description.present? %>
                    <p class="mt-1 text-sm text-gray-600 <%= 'line-through' if task.completed? %>">
                      <%= highlight_search_term(task.description, params[:search]) %>
                    </p>
                  <% end %>
                  
                  <!-- Subtask Progress -->
                  <% if task.has_subtasks? %>
                    <div class="mt-2">
                      <div class="flex items-center space-x-2">
                        <span class="text-xs text-gray-500">
                          üìù <%= task.completed_subtasks_count %>/<%= task.subtasks_count %> subtasks
                        </span>
                        <div class="flex-1 bg-gray-200 rounded-full h-1.5 max-w-24">
                          <div class="bg-blue-600 h-1.5 rounded-full" style="width: <%= task.subtasks_completion_percentage %>%"></div>
                        </div>
                        <span class="text-xs text-gray-500"><%= task.subtasks_completion_percentage %>%</span>
                        <% if task.has_pending_subtasks? && !task.completed? %>
                          <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800" title="Complete all subtasks before marking this task as done">
                            ‚ö†Ô∏è Pending
                          </span>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                  
                  <!-- Due Date -->
                  <% if task.due_date.present? %>
                    <div class="mt-2 flex items-center space-x-2">
                      <span class="text-sm text-gray-500">
                        üìÖ <%= task.due_date.strftime("%b %d, %Y at %I:%M %p") %>
                      </span>
                      <% if task.overdue? %>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                          ‚ö†Ô∏è OVERDUE
                        </span>
                      <% elsif task.due_today? %>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                          üìÖ DUE TODAY
                        </span>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              </div>
              
            </div>
          <% end %>
          
          <!-- Actions (Outside the link to prevent conflicts) -->
          <div class="absolute top-4 right-4 flex items-center space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
            <%= button_to (task.completed ? "Mark as Pending" : "Mark as Done"),
                toggle_task_path(task),
                method: :patch,
                class: "inline-flex items-center px-2 py-1 border border-gray-300 shadow-sm text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500",
                onclick: "event.stopPropagation()" %>
            
            <%= link_to "Edit", edit_task_path(task),
                class: "inline-flex items-center px-2 py-1 border border-gray-300 shadow-sm text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500",
                onclick: "event.stopPropagation()" %>
            
            <%= link_to "Delete", task,
                method: :delete,
                data: { "turbo-method": "delete", "turbo-confirm": "Are you sure?" },
                class: "inline-flex items-center px-2 py-1 border border-red-300 shadow-sm text-xs font-medium rounded text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-1 focus:ring-red-500",
                onclick: "event.stopPropagation()" %>
          </div>
        </li>
      <% end %>
    </ul>
  <% else %>
    <div class="text-center py-12">
      <% if params[:search].present? || params[:completed].present? || params[:priority].present? || params[:category_id].present? || params[:filter].present? || params[:quick_filter].present? %>
        <!-- No results for filters -->
        <span class="text-6xl">üîç</span>
        <h3 class="mt-2 text-sm font-medium text-gray-900">No tasks match your filters</h3>
        <p class="mt-1 text-sm text-gray-500">Try adjusting your search terms or filters to find what you're looking for.</p>
        <div class="mt-6 space-x-3">
          <%= link_to "Clear all filters", tasks_path,
              class: "inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" %>
          <%= link_to "Create new task", new_task_path,
              class: "inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" %>
        </div>
      <% else %>
        <!-- No tasks at all -->
        <span class="text-6xl">üìù</span>
        <h3 class="mt-2 text-sm font-medium text-gray-900">No tasks yet</h3>
        <p class="mt-1 text-sm text-gray-500">Get started by creating your first task.</p>
        <div class="mt-6">
          <%= link_to "Create your first task", new_task_path,
              class: "inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" %>
        </div>
      <% end %>
    </div>
  <% end %>
      <!-- Pagination -->
      <% if @tasks.any? %>
        <div class="mt-8 flex justify-between items-center">
          <div class="flex items-center space-x-4">
            <span class="text-sm text-gray-700">
              Showing tasks <%= @pagy.from %> to <%= @pagy.to %> of <%= @pagy.count %> total
            </span>
            
            <!-- Items per page selector -->
            <div class="relative">
              <%= select_tag :items,
                options_for_select([10, 15, 25, 50, 100], @pagy.items),
                class: "block pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md",
                data: { action: "change->tasks#changeItemsPerPage" } %>
            </div>
          </div>
          
          <!-- Pagination links -->
          <div class="flex justify-end">
            <%== pagy_nav(@pagy) %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>
